generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_PG")
}

model User {
  id                   Int             @id @default(autoincrement())
  email                String          @unique
  name                 String?
  password             String?
  isVerified           Boolean         @default(false)
  verificationToken    String?
  verificationExpires  DateTime?
  googleId             String?         @unique
  avatar               String?
  createdAt            DateTime        @default(now())
  resetPasswordExpires DateTime?
  resetPasswordToken   String?
  // Subscription Fields
  planType             String          @default("free") // 'free', 'paid'
  trialExpiresAt       DateTime?
  subscriptionStatus   String          @default("active") // 'active', 'expired'
  subscriptionExpiresAt DateTime?
  lastPaymentId        String?
  
  automations          Automation[]
  dispatches           Dispatch[]
  emailCampaigns       EmailCampaign[]
  emailTemplates       EmailTemplate[]
  flows                Flow[]
  config               UserConfig?
}

model UserConfig {
  id                    Int     @id @default(autoincrement())
  userId                Int     @unique
  token                 String  @default("")
  phoneId               String  @default("")
  wabaId                String  @default("")
  templateName          String  @default("")
  mapping               String  @default("{}")
  webhookVerifyToken    String  @default("")
  webhookToken          String  @default("")
  evolutionApiUrl       String  @default("")
  evolutionApiKey       String  @default("")
  evolutionInstanceName String  @default("")
  evolutionWebhookToken String  @default("")
  evolutionConnected    Boolean @default(false)
  businessHours         String  @default("{}")
  automationDelay       Int     @default(1440) // Delay in minutes for re-entry protection
  sessionWaitTime       Int     @default(1440) // Time in minutes to wait for user reply before expiration
  agentLockoutTime      Int     @default(2160) // Lockout in minutes after agent message (default 36h)
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Dispatch {
  id           Int           @id @default(autoincrement())
  userId       Int
  templateName String
  dateOld      String
  dateNew      String
  status       String        @default("idle")
  totalLeads   Int           @default(0)
  currentIndex Int           @default(0)
  successCount Int           @default(0)
  errorCount   Int           @default(0)
  leadsData    String        @default("[]")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  dispatchType String        @default("template")
  flowId       Int?
  variables    String?       @default("[]")
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         DispatchLog[]
}

model DispatchLog {
  id         Int      @id @default(autoincrement())
  dispatchId Int
  phone      String
  status     String
  message    String?
  createdAt  DateTime @default(now())
  dispatch   Dispatch @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
}

model ReceivedMessage {
  id              Int      @id @default(autoincrement())
  whatsappPhoneId String   @default("")
  contactPhone    String
  contactName     String
  messageBody     String
  isFromMe        Boolean  @default(false)
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())
  mediaId         String?
  mediaType       String?
  mediaUrl        String?
}

model Flow {
  id        Int           @id @default(autoincrement())
  userId    Int
  name      String
  nodes     String        @default("[]")
  edges     String        @default("[]")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions  FlowSession[]
}

model FlowSession {
  id           Int              @id @default(autoincrement())
  flowId       Int?
  automationId Int?
  contactPhone String
  currentStep  String?
  status       String           @default("active")
  variables    String           @default("{}")
  platform     String           @default("meta")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  scheduledAt  DateTime?
  automation   Automation?      @relation(fields: [automationId], references: [id], onDelete: Cascade)
  flow         Flow?            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  logs         FlowSessionLog[]
}

model FlowSessionLog {
  id        Int         @id @default(autoincrement())
  sessionId Int
  nodeId    String?
  nodeName  String?
  action    String
  details   String?
  createdAt DateTime    @default(now())
  session   FlowSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id        Int             @id @default(autoincrement())
  userId    Int
  name      String
  subject   String          @default("")
  html      String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  campaigns EmailCampaign[]
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailCampaign {
  id           Int                @id @default(autoincrement())
  userId       Int
  templateId   Int?
  name         String
  subject      String             @default("")
  status       String             @default("idle")
  totalLeads   Int                @default(0)
  currentIndex Int                @default(0)
  successCount Int                @default(0)
  errorCount   Int                @default(0)
  leadsData    String             @default("[]")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  template     EmailTemplate?     @relation(fields: [templateId], references: [id])
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         EmailCampaignLog[]
}

model EmailCampaignLog {
  id         Int           @id @default(autoincrement())
  campaignId Int
  email      String
  status     String
  message    String?
  createdAt  DateTime      @default(now())
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

model EvolutionMessage {
  id            Int      @id @default(autoincrement())
  userId        Int
  instanceName  String
  contactPhone  String
  contactName   String   @default("Cliente")
  pushName      String?
  messageBody   String
  isFromMe      Boolean  @default(false)
  isRead        Boolean  @default(false)
  mediaUrl      String?
  mediaType     String?
  profilePicUrl String?
  remoteJid     String?
  messageId     String?
  createdAt     DateTime @default(now())
}

model Automation {
  id              Int           @id @default(autoincrement())
  userId          Int
  name            String
  isActive        Boolean       @default(true)
  triggerType     String        @default("keyword")
  triggerKeywords String        @default("")
  conditions      String        @default("[]")
  flowId          Int?
  nodes           String        @default("[]")
  edges           String        @default("[]")
  sessionWaitTime Int           @default(1440) // Session expiration in minutes (per-automation)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions        FlowSession[]
}
